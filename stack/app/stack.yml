version: "3.8"
services:
  nginx:
    image: nginx:1.20.0-alpine
    labels:
      - app=nginx
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: any
        delay: 1s
        window: 10s
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - mode: host
        protocol: tcp
        published: 80
        target: 80
      - mode: host
        protocol: tcp
        published: 443
        target: 443
    networks:
      - app
  python-app:
    labels:
      - app=app
    image: x5python-app
    networks:
      - app
    logging:
      driver: "json-file"
      options:
        max-size: "200k"
        max-file: "10"
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: any
        delay: 1s
        window: 10s
  app:
    labels:
      - app=app
    image: x5app
    networks:
      - app
    logging:
      driver: "json-file"
      options:
        max-size: "200k"
        max-file: "10"
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: any
        delay: 1s
        window: 10s
    environment:
      - PORT=3333
      - HOST=0.0.0.0
      - NODE_ENV=development
      - APP_KEY=3_7yprD0-_s1L_Wc6w81cbhcxhodx9q_
      - SESSION_DRIVER=cookie
      - CACHE_VIEWS=false
      - DB_CONNECTION=mysql
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=app
      - MYSQL_PASSWORD=app
      - MYSQL_DB_NAME=app
      - SESSION_DRIVER=redis
      - REDIS_CONNECTION=local
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - TREE_VISUALIZE_URL=http://python-app:8000/get-tree

networks:
  app:
    external: true